//虚表
//相关范例：范例 / 数据库 / sqlite / 虚表
//下面listview 控件的类名（cls属性）请改为 "vlistview"
import win.ui;
import sqlite;
import console;
/*DSG{{*/
winform = win.form(text="虚表";right=805;bottom=610)
winform.add(
listview={cls="vlistview";left=370;top=95;right=778;bottom=564;db=1;dl=1;dr=1;dt=1;edge=1;mode="icon";z=1};
listview2={cls="listview";left=65;top=91;right=290;bottom=561;edge=1;z=2}
)
/*}}*/

// 一级级区域
var quer_db = sqlite("\sqlite\rmkj.db");
winform.listview2.insertColumn("一级区域列表",219) 
for rowid,area1_id,area1_name in quer_db.each("SELECT rowid,area1_id,area1_name from tbarea1 ORDER BY id DESC;") {
	winform.listview2.addItem( { 
		text={area1_name} 
	} )

}

// 一级级区域
winform.listview2.onnotify = function(id,code,ptr){
    select(code) {
    	case  0xFFFFFF9B /*_LVN_ITEMCHANGED*/ {
    		var nm = winform.listview2.getNotifyMessage(code,ptr)
    		// 处理点击事件
    		if ( (nm.uChanged & 0x8/*_LVIF_STATE*/) && (nm.uNewState & 0x2/*_LVIS_SELECTED*/) ) {
            	if(winform.listview2.selIndex){
            	    var area1_name = winform.listview2.getItemText(nm.iItem,nm.iSubItem);
            		var info =  "选择的区域 :" +  area1_name;
        			
        			region_a2_list();
        			}
                }
    	}
    }
}



import win.imageList;
var imageList = win.imageList(32, 32); 
var data = {};
winform.listview.setImageList( imageList.loadIcon(0x7F00) );
region_a2_list = function(){
	var quer_db = sqlite("\sqlite\rmkj.db");
	var father_id = 1100000001;
	for (i = winform.listview.columnCount; 1; -1) {
		winform.listview.delColumn(i);
	}
	for rowid,area2_id,area2_name in quer_db.each("SELECT rowid,area2_id,area2_name from tbarea2 where father_id = '" ++ father_id ++"'  ORDER BY id DESC;") {
		winform.listview.addItem( { 
			table.push(data,{ { iImage = 0; text = area2_id } }) 
		} )
	
	}
	
	//指定虚表行数
	//winform.listview.count = 1000;
}
//获取虚表项
winform.listview.onGetDispItem = function(item,row,col){
	return  data[row][col]; 
} 
winform.show();
win.loopMessage();